#!/usr/bin/env sh

# Takes a c++ program, compiles, and executes. Deletes the executable by default (can be changed).

USAGE="Usage:
    crun [-p] [-o output_file] file.cpp"

preserve_exec=false
custom_output_file=false
raw_program=${@: -1}

while getopts 'dhpo:' OPTION; do
    case "$OPTION" in

        p)
            # preserves the executable file generated by gcc

            preserve_exec=true
            ;;

        h)
            # displays help message

            echo "Crun takes a c++ program, compiles, and executes. Deletes the executable by default."
            echo $USAGE
            echo

            echo "-p    preserves executable file after running"
            echo "-o    changes the executable file name"
            echo "-h    shows this help page"
            echo

            echo "NOTE: The executable file generated when compiling will be named as the original program without the file extension. If there is a conflict, avoid overwriting a file using the -o flag."
            exit 1
            ;;

        o)
            # overrides the default output file name

            output_file="$OPTARG"
            custom_output_file=true
            ;;

        ?)
            # any invalid flags

            echo "Invalid usage."
            echo $USAGE
            echo "crun -h for more information"
            exit 1
            ;;
    esac
done

# if the given program exists
if [ -f "$raw_program" ]; then

    # if the user did not set a custom output file
    if [ $custom_output_file != "true" ]; then
        output_file=${raw_program%.*} # the output file becomes the program without the file extension
    fi

    # if a file with the same name as the output file already exists
    if [ -f "$output_file" ]; then
        # warn user and terminate crun
        echo "File '$output_file' already exists. This process will likely overwrite or delete it.
crun -h for more information."
        exit 1
    fi

    # compile
    g++ -std=c++17 -O2 $raw_program -o $output_file

    # run
    ./$output_file

    # if the user did not pass -p flag
    if [ $preserve_exec != "true" ]; then
        rm $output_file # delete the executable
    fi

# if no such file exists
else
    # display error and terminate crun
    echo "Invalid usage: file '"$raw_program"' does not exist."
    echo $USAGE
    exit 1

fi
